<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stock Price vs P/E Ratio</title>
  <!-- Include Plotly.js -->
  <script src="https://cdn.plot.ly/plotly-3.0.1.min.js"></script>
  <!-- Optional: Include a loading spinner -->
  <style>
    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
    }
    #plotly-chart {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <!-- Loading spinner -->
  <div id="loading">Loading...</div>
  <!-- Div to hold the plot -->
  <div id="plotly-chart"></div>

  <script>
    // Function to fetch data from Google Sheets
    async function fetchData() {
      const sheetId = '1_-Q7pODEkdZXQnIGtZjps_0uPI1E5txwm8ukHC78_Ms'; // Replace with your Google Sheets ID
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=Sheet1`;

      try {
        const response = await fetch(url);
        const data = await response.text();
        processData(data);
      } catch (error) {
        console.error('Error fetching data:', error);
      }
    }

    // Function to process the fetched CSV data
    function processData(csvData) {
      const rows = csvData.split('\n').slice(1); // Skip header row
      const symbols = [];
      const peRatios = [];
      const prices = [];

      rows.forEach(row => {
        const cols = row.split(',');

        // Remove extra spaces, and check for invalid data
        const symbol = cols[0]?.trim();
        const peRatio = parseFloat(cols[1]?.trim());
        const price = parseFloat(cols[2]?.trim());

        // Check if P/E Ratio and Price are valid numbers and not '#N/A'
        if (symbol && !isNaN(peRatio) && !isNaN(price)) {
          symbols.push(symbol);
          peRatios.push(peRatio);
          prices.push(price);
        }
      });

      createPlot(peRatios, prices, symbols);
    }

    // Function to create the Plotly chart
    function createPlot(peRatios, prices, symbols) {
      const trace = {
        x: peRatios,
        y: prices,
        mode: 'markers',
        type: 'scatter',
        text: symbols,
        marker: { size: 12 }
      };

      const layout = {
        title: 'Stock Price vs P/E Ratio',
        xaxis: { title: 'P/E Ratio' },
        yaxis: { title: 'Price (USD)' }
      };

      Plotly.newPlot('plotly-chart', [trace], layout);

      // Hide the loading spinner and display the plot
      document.getElementById('loading').style.display = 'none';
      document.getElementById('plotly-chart').style.display = 'block';
    }

    // Fetch data and create the plot when the page loads
    window.onload = fetchData;
  </script>
</body>
</html>
